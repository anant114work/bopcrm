{% extends 'leads/base_unified.html' %}

{% block title %}Bulk Calling Panel{% endblock %}
{% block page_title %}Bulk Calling Panel{% endblock %}



{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Bulk Calling Panel</h3>
                    <div class="d-flex gap-2">
                        <select id="agentSelect" class="form-select" style="width: 200px;">
                            {% for agent in agent_numbers %}
                            <option value="{{ agent }}">Agent {{ agent }}</option>
                            {% endfor %}
                        </select>
                        <button id="startBulkBtn" class="btn btn-primary">Start Bulk Calling</button>
                        <button id="pauseBtn" class="btn btn-warning" disabled onclick="togglePause()">Pause</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Status Panel -->
                    <div id="statusPanel" class="alert alert-info" style="display: none;">
                        <div id="statusMessage"></div>
                        <div id="progressBar" class="progress mt-2" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Scheduled Call Interrupt Modal -->
                    <div id="scheduledCallModal" class="modal fade" tabindex="-1" style="display: none;">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Scheduled Call Due</h5>
                                </div>
                                <div class="modal-body">
                                    <p id="scheduledCallMessage"></p>
                                </div>
                                <div class="modal-footer">
                                    <button id="handleScheduledBtn" class="btn btn-success">Handle Scheduled Call</button>
                                    <button id="continueBulkBtn" class="btn btn-secondary">Continue Bulk</button>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Leads Selection -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Project</th>
                                    <th>Stage</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in leads %}
                                <tr>
                                    <td><input type="checkbox" class="lead-checkbox" value="{{ lead.id }}"></td>
                                    <td>{{ lead.full_name }}</td>
                                    <td>{{ lead.phone_number }}</td>
                                    <td>{{ lead.form_name }}</td>
                                    <td><span class="badge bg-primary">{{ lead.stage }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-success single-call" data-id="{{ lead.id }}" data-phone="{{ lead.phone_number }}">
                                            Call Now
                                        </button>
                                        <button class="btn btn-sm btn-info schedule-call" data-id="{{ lead.id }}">
                                            Schedule
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let bulkCallState = {
    isRunning: false,
    currentLeads: [],
    currentIndex: 0,
    scheduledCallData: null,
    intervalTimer: null,
    countdown: 0
};

// Select all functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.lead-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// Start bulk calling
document.getElementById('startBulkBtn').addEventListener('click', function() {
    const selectedLeads = Array.from(document.querySelectorAll('.lead-checkbox:checked')).map(cb => cb.value);
    const agentNumber = document.getElementById('agentSelect').value;
    
    if (selectedLeads.length === 0) {
        alert('Please select leads to call');
        return;
    }
    
    bulkCallState.currentLeads = selectedLeads;
    bulkCallState.isRunning = true;
    
    showStatus(`üöÄ Starting bulk call for ${selectedLeads.length} leads... Agent phone will ring for each call.`, 'info');
    
    fetch('/start-bulk-calling/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            lead_ids: selectedLeads,
            agent_number: agentNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Bulk call response:', data);
        if (data.success && data.bulk_started) {
            bulkCallState.currentLeads = selectedLeads;
            bulkCallState.currentIndex = 1;
            bulkCallState.isRunning = true;
            document.getElementById('pauseBtn').disabled = false;
            setBulkCallingState(true);
            startScheduledCallChecking(); // More frequent checks during bulk calling
            
            showStatus(`üìû Called ${data.current_lead.name}. Waiting 3 minutes before next call...`, 'info');
            
            if (data.remaining_leads > 0) {
                startCountdown(180);
            } else {
                showStatus('‚úÖ All calls completed!', 'success');
                bulkCallState.isRunning = false;
            }
        } else if (data.success && data.total_processed) {
            // This is the old bulk response - we need to fix the backend
            showStatus(`‚ùå Backend returned old format. ${data.successful_calls} calls made immediately instead of 2-minute intervals!`, 'warning');
            bulkCallState.isRunning = false;
        } else {
            showStatus(`Error: ${data.error || 'Unknown error'}`, 'danger');
        }
    })
    .catch(error => {
        showStatus(`Error: ${error}`, 'danger');
    });
});

function handleScheduledInterrupt(data) {
    bulkCallState.scheduledCallData = data;
    const modal = new bootstrap.Modal(document.getElementById('scheduledCallModal'));
    document.getElementById('scheduledCallMessage').textContent = 
        `Scheduled call for ${data.scheduled_call.customer_number} at ${data.scheduled_call.schedule_date_time}. ${data.remaining_leads} leads remaining in bulk.`;
    modal.show();
}

// Handle scheduled call
document.getElementById('handleScheduledBtn').addEventListener('click', function() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('scheduledCallModal'));
    modal.hide();
    
    showStatus('Handling scheduled call...');
    
    fetch('/handle-scheduled-call/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            scheduled_call: bulkCallState.scheduledCallData.scheduled_call
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Scheduled call initiated. Resume bulk calling?');
            setTimeout(() => {
                if (confirm('Resume bulk calling?')) {
                    resumeBulkCalling();
                }
            }, 2000);
        } else {
            showStatus(`Scheduled call failed: ${data.message}`, 'danger');
        }
    });
});

// Continue bulk calling
document.getElementById('continueBulkBtn').addEventListener('click', function() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('scheduledCallModal'));
    modal.hide();
    resumeBulkCalling();
});

function resumeBulkCalling() {
    showStatus('Resuming bulk calling...');
    
    fetch('/resume-bulk-calling/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            lead_ids: bulkCallState.currentLeads,
            start_index: bulkCallState.scheduledCallData.current_index,
            agent_number: document.getElementById('agentSelect').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('Bulk calling resumed and completed!');
            bulkCallState.isRunning = false;
        } else {
            showStatus(`Resume failed: ${data.error}`, 'danger');
        }
    });
}

function showStatus(message, type = 'info') {
    const panel = document.getElementById('statusPanel');
    const messageEl = document.getElementById('statusMessage');
    
    panel.className = `alert alert-${type}`;
    messageEl.textContent = message;
    panel.style.display = 'block';
}

// Schedule call functionality
document.querySelectorAll('.schedule-call').forEach(btn => {
    btn.addEventListener('click', function() {
        const leadId = this.dataset.id;
        const row = this.closest('tr');
        const leadName = row.querySelector('td:nth-child(2)').textContent;
        const leadPhone = row.querySelector('td:nth-child(3)').textContent;
        
        // Set current date and time as default
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const currentTime = now.toTimeString().slice(0, 5);
        
        document.getElementById('scheduleLeadName').textContent = leadName;
        document.getElementById('scheduleLeadPhone').textContent = leadPhone;
        document.getElementById('scheduleDate').value = today;
        document.getElementById('scheduleTime').value = currentTime;
        
        // Store lead ID for saving
        document.getElementById('scheduleModal').dataset.leadId = leadId;
        
        // Show modal using simple display
        document.getElementById('scheduleModal').style.display = 'block';
        document.getElementById('scheduleModal').classList.add('show');
    });
});

function saveSchedule() {
    const leadId = document.getElementById('scheduleModal').dataset.leadId;
    const date = document.getElementById('scheduleDate').value;
    const time = document.getElementById('scheduleTime').value;
    
    if (!date || !time) {
        alert('Please select both date and time');
        return;
    }
    
    const scheduleDateTime = `${date}T${time}:00`;
    
    fetch('/schedule-callback/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            lead_id: leadId,
            schedule_datetime: scheduleDateTime,
            agent_id: document.getElementById('agentSelect').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(`üìÖ Call scheduled for ${date} at ${time}`, 'success');
            document.getElementById('scheduleModal').style.display = 'none';
            document.getElementById('scheduleModal').classList.remove('show');
        } else {
            showStatus(`Schedule failed: ${data.message}`, 'danger');
        }
    })
    .catch(error => {
        showStatus(`Schedule error: ${error}`, 'danger');
    });
}

// Single call functionality
document.querySelectorAll('.single-call').forEach(btn => {
    btn.addEventListener('click', function() {
        const leadId = this.dataset.id;
        const phone = this.dataset.phone;
        const agentNumber = document.getElementById('agentSelect').value;
        
        showStatus(`Calling ${phone}...`);
        
        // For single calls, use the individual call endpoint
        fetch('/initiate-click-call/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                phone: phone,
                lead_name: this.closest('tr').querySelector('td:nth-child(2)').textContent
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus(`‚úÖ Call initiated to ${phone}! Agent phone will ring first.`, 'success');
            } else {
                showStatus(`Call failed: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            showStatus(`Network error: ${error}`, 'danger');
        });
        
        return; // Don't execute the bulk call logic below
        
        
        return; // Use individual call endpoint above
        
        /*fetch('/start-bulk-calling/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                lead_ids: [leadId],
                agent_number: agentNumber
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus(`‚úÖ Call initiated to ${phone}! Agent phone will ring first.`, 'success');
            } else {
                showStatus(`Call failed: ${data.error}`, 'danger');
            }
        }); */
    });
});

// Add modal HTML after page loads
document.addEventListener('DOMContentLoaded', function() {
    const modalHTML = `
        <div id="scheduleModal" class="modal fade" tabindex="-1" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050;">
            <div class="modal-dialog" style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; max-width: 90%;">
                <div class="modal-content" style="background: white; border-radius: 8px; padding: 0;">
                    <div class="modal-header" class="d-flex">
                        <h5 class="modal-title" style="margin: 0;">Schedule Call</h5>
                        <button type="button" class="btn-close" onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div class="mb-3" style="margin-bottom: 15px;">
                            <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">Lead Name:</label>
                            <div id="scheduleLeadName" class="fw-bold" style="font-weight: bold;"></div>
                        </div>
                        <div class="mb-3" style="margin-bottom: 15px;">
                            <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">Phone:</label>
                            <div id="scheduleLeadPhone" class="fw-bold" style="font-weight: bold;"></div>
                        </div>
                        <div class="mb-3" style="margin-bottom: 15px;">
                            <label for="scheduleDate" class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">Date:</label>
                            <input type="date" id="scheduleDate" class="form-control" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="mb-3" style="margin-bottom: 15px;">
                            <label for="scheduleTime" class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">Time:</label>
                            <input type="time" id="scheduleTime" class="form-control" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    <div class="modal-footer" class="d-flex">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" style="padding: 8px 16px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 4px; cursor: pointer;">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveSchedule()" style="padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">Schedule Call</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
});

function closeModal() {
    document.getElementById('scheduleModal').style.display = 'none';
    document.getElementById('scheduleModal').classList.remove('show');
}

// Check for scheduled calls every 30 seconds during bulk calling, every minute otherwise
let scheduledCallInterval;

function startScheduledCallChecking() {
    if (scheduledCallInterval) clearInterval(scheduledCallInterval);
    const interval = bulkCallState.isRunning ? 30000 : 60000; // 30s during bulk, 60s otherwise
    scheduledCallInterval = setInterval(checkScheduledCalls, interval);
}

// Start checking immediately
startScheduledCallChecking();

function checkScheduledCalls() {
    fetch('/check-scheduled-calls/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.scheduled_calls && data.scheduled_calls.length > 0) {
            data.scheduled_calls.forEach(call => {
                console.log('üìû Executing scheduled call:', call);
                executeScheduledCall(call);
            });
        }
        
        // Handle pending calls that conflict with bulk calling
        if (data.pending_calls && data.pending_calls.length > 0) {
            data.pending_calls.forEach(call => {
                showScheduledCallInterrupt(call);
            });
        }
    })
    .catch(error => console.log('Scheduled call check error:', error));
}

function executeScheduledCall(scheduledCall) {
    fetch('/initiate-click-call/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            phone: scheduledCall.phone,
            lead_name: scheduledCall.name
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(`üìû Scheduled call executed for ${scheduledCall.name}`, 'success');
        }
    });
}

function showScheduledCallInterrupt(pendingCall) {
    const message = `You have a scheduled call for ${pendingCall.name} (${pendingCall.phone}) at ${pendingCall.scheduled_time}. Pause bulk calling and attend scheduled call?`;
    
    if (confirm(message)) {
        // User chose to handle scheduled call
        handleScheduledInterrupt(pendingCall.id, 'execute');
    } else {
        // User chose to skip - postpone the call
        handleScheduledInterrupt(pendingCall.id, 'skip');
    }
}

function handleScheduledInterrupt(callId, action) {
    fetch('/handle-scheduled-interrupt/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            call_id: callId,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(data.message, 'info');
            if (action === 'execute') {
                // Pause bulk calling temporarily
                if (bulkCallState.isRunning) {
                    togglePause();
                }
            }
        } else {
            showStatus(`Error: ${data.error}`, 'danger');
        }
    });
}

function startCountdown(seconds) {
    bulkCallState.countdown = seconds;
    const progressBar = document.getElementById('progressBar');
    progressBar.style.display = 'block';
    
    bulkCallState.intervalTimer = setInterval(() => {
        bulkCallState.countdown--;
        
        const minutes = Math.floor(bulkCallState.countdown / 60);
        const secs = bulkCallState.countdown % 60;
        const timeStr = `${minutes}:${secs.toString().padStart(2, '0')}`;
        
        const progress = ((120 - bulkCallState.countdown) / 120) * 100;
        document.querySelector('.progress-bar').style.width = `${progress}%`;
        
        showStatus(`‚è±Ô∏è Next call in ${timeStr}. Lead ${bulkCallState.currentIndex}/${bulkCallState.currentLeads.length}`, 'info');
        
        if (bulkCallState.countdown <= 0) {
            console.log('‚è∞ Countdown finished! Making next call...');
            clearInterval(bulkCallState.intervalTimer);
            makeNextCall();
        }
    }, 1000);
}

function makeNextCall() {
    console.log('üîÑ makeNextCall() called - currentIndex:', bulkCallState.currentIndex, 'totalLeads:', bulkCallState.currentLeads.length);
    
    if (bulkCallState.currentIndex >= bulkCallState.currentLeads.length) {
        console.log('‚úÖ All calls completed!');
        showStatus('‚úÖ All bulk calls completed!', 'success');
        bulkCallState.isRunning = false;
        document.getElementById('progressBar').style.display = 'none';
        return;
    }
    
    console.log('üìû Making call to lead ID:', bulkCallState.currentLeads[bulkCallState.currentIndex]);
    
    fetch('/continue-bulk-calling/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            lead_ids: bulkCallState.currentLeads,
            current_index: bulkCallState.currentIndex
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('üìû Call response:', data);
        if (data.success) {
            if (data.completed) {
                console.log('‚úÖ Bulk calling completed!');
                showStatus('‚úÖ All bulk calls completed!', 'success');
                bulkCallState.isRunning = false;
                document.getElementById('progressBar').style.display = 'none';
                setBulkCallingState(false);
                startScheduledCallChecking(); // Return to normal checking
            } else {
                console.log('üìû Call successful, setting up next call timer');
                bulkCallState.currentIndex = data.current_index;
                showStatus(`üìû Called ${data.current_lead.name}. Waiting 3 minutes before next call...`, 'info');
                
                if (data.remaining_leads > 0) {
                    console.log('‚è∞ Starting 2-minute countdown for next call');
                    startCountdown(120);
                } else {
                    console.log('‚úÖ No more leads remaining');
                    showStatus('‚úÖ All calls completed!', 'success');
                    bulkCallState.isRunning = false;
                    document.getElementById('progressBar').style.display = 'none';
                }
            }
        } else {
            console.log('‚ùå Call failed:', data.error);
            showStatus(`Call failed: ${data.error}`, 'danger');
            setTimeout(() => {
                console.log('‚è∞ Retrying next call after failure in 30 seconds');
                bulkCallState.currentIndex++;
                makeNextCall();
            }, 30000);
        }
    })
    .catch(error => {
        console.log('‚ùå Network error:', error);
        showStatus(`Network error: ${error}`, 'danger');
        setTimeout(() => {
            console.log('‚è∞ Retrying next call after network error in 30 seconds');
            bulkCallState.currentIndex++;
            makeNextCall();
        }, 30000);
    });
}

function togglePause() {
    const pauseBtn = document.getElementById('pauseBtn');
    if (bulkCallState.isRunning) {
        clearInterval(bulkCallState.intervalTimer);
        bulkCallState.isRunning = false;
        showStatus('‚è∏Ô∏è Bulk calling paused', 'warning');
        pauseBtn.textContent = 'Resume';
        pauseBtn.className = 'btn btn-success';
        setBulkCallingState(false);
    } else {
        bulkCallState.isRunning = true;
        startCountdown(bulkCallState.countdown || 120);
        pauseBtn.textContent = 'Pause';
        pauseBtn.className = 'btn btn-warning';
        setBulkCallingState(true);
    }
}

function setBulkCallingState(isActive) {
    fetch('/set-bulk-calling-state/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            is_active: isActive
        })
    })
    .catch(error => console.log('Error setting bulk calling state:', error));
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}