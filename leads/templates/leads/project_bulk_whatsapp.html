{% extends 'leads/base_unified.html' %}
{% load lead_filters %}

{% block title %}Bulk WhatsApp - {{ project.name }}{% endblock %}
{% block page_title %}üì¢ Bulk WhatsApp - {{ project.name }}{% endblock %}

{% block content %}
<div class="card">
    <h3>Send WhatsApp to Project Leads</h3>
    <p style="color: #6b7280; margin-bottom: 2rem;">Send WhatsApp messages to all leads in {{ project.name }}</p>
    
    <div class="gap-2">
        <div>
            <h4>üìä Project Stats</h4>
            <div style="background: #f0f9ff; padding: 1rem; border-radius: 6px;">
                <div><strong>Total Leads:</strong> {{ project.lead_count }}</div>
                <div><strong>With Phone:</strong> {{ leads_with_phone }}</div>
                <div><strong>Available Templates:</strong> {{ templates.count }}</div>
                <div><strong>Drip Campaigns:</strong> {{ drip_campaigns.count }}</div>
            </div>
        </div>
        
        <div>
            <h4>üì± Select Campaign</h4>
            <select id="campaignSelect" class="form-control" onchange="updatePreview()">
                <option value="">Choose a campaign...</option>
                {% if templates.count > 0 %}
                <optgroup label="WhatsApp Templates">
                    {% for template in templates %}
                    <option value="template_{{ template.id }}" data-type="template">{{ template.name }}</option>
                    {% endfor %}
                </optgroup>
                {% endif %}
                {% if drip_campaigns.count > 0 %}
                <optgroup label="Drip Campaigns (SPJ)">
                    {% for campaign in drip_campaigns %}
                    <option value="drip_{{ campaign.id }}" data-type="drip">{{ campaign.name }} ({{ campaign.messages.count }} messages)</option>
                    {% endfor %}
                </optgroup>
                {% endif %}
            </select>
        </div>
    </div>
    
    <div id="messagePreview" style="display: none; background: #f0f9ff; padding: 1rem; border-radius: 6px; margin-bottom: 2rem;">
        <h4>Message Preview:</h4>
        <div id="previewContent"></div>
    </div>
    
    <div class="d-flex">
        <button class="btn btn-success" onclick="sendBulkMessages()" id="sendBtn" disabled>
            üì¢ Send to All Leads ({{ leads_with_phone }})
        </button>
        <button class="btn btn-primary" onclick="sendToSelected()">
            üìã Send to Selected Leads
        </button>
        <button class="btn btn-warning" onclick="processPendingMessages()" style="margin-left: auto;">
            üöÄ Process Pending Messages
        </button>
    </div>
    
    <div id="sendResults" style="margin-bottom: 2rem;"></div>
</div>

<div class="card">
    <h3>Project Leads with Phone Numbers</h3>
    <table>
        <thead>
            <tr>
                <th style="width: 40px;"><input type="checkbox" id="selectAll" onchange="toggleAll()"></th>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads %}
            <tr>
                <td><input type="checkbox" class="lead-checkbox" value="{{ lead.id }}"></td>
                <td>{{ lead.full_name|default:"No Name" }}</td>
                <td>{% maskable_number lead.phone_number "phone" %}</td>
                <td>{{ lead.email|default:"-" }}</td>
                <td>{{ lead.created_time|date:"M d, Y" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">No leads with phone numbers found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function updatePreview() {
    const select = document.getElementById('campaignSelect');
    const preview = document.getElementById('messagePreview');
    const sendBtn = document.getElementById('sendBtn');
    
    if (select.value) {
        preview.style.display = 'block';
        sendBtn.disabled = false;
        document.getElementById('previewContent').innerHTML = 'Campaign selected: ' + select.options[select.selectedIndex].text;
    } else {
        preview.style.display = 'none';
        sendBtn.disabled = true;
    }
}

function toggleAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.lead-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

function sendBulkMessages() {
    const selectValue = document.getElementById('campaignSelect').value;
    if (!selectValue) {
        alert('Please select a campaign');
        return;
    }
    
    const [type, id] = selectValue.split('_');
    const resultsDiv = document.getElementById('sendResults');
    
    if (type === 'drip') {
        // For drip campaigns, subscribe leads
        resultsDiv.innerHTML = '<div style="background: #fef3c7; color: #92400e; padding: 1rem; border-radius: 6px;">Subscribing all leads to drip campaign...</div>';
        
        fetch('/drip-campaigns/bulk-subscribe/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                campaign_id: id,
                project_id: {{ project.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultsDiv.innerHTML = `<div style="background: #ecfdf5; color: #065f46; padding: 1rem; border-radius: 6px;">‚úÖ ${data.message}<br>Subscribed: ${data.subscribed_count}, Already subscribed: ${data.already_subscribed}</div>`;
            } else {
                resultsDiv.innerHTML = `<div style="background: #fef2f2; color: #991b1b; padding: 1rem; border-radius: 6px;">‚ùå ${data.error}</div>`;
            }
        });
    } else {
        // For regular templates, send WhatsApp
        resultsDiv.innerHTML = '<div style="background: #fef3c7; color: #92400e; padding: 1rem; border-radius: 6px;">Sending messages to all leads...</div>';
        
        fetch('/projects/{{ project.id }}/send-bulk-whatsapp/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                template_id: id,
                send_to_all: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultsDiv.innerHTML = `<div style="background: #ecfdf5; color: #065f46; padding: 1rem; border-radius: 6px;">‚úÖ ${data.message}</div>`;
            } else {
                resultsDiv.innerHTML = `<div style="background: #fef2f2; color: #991b1b; padding: 1rem; border-radius: 6px;">‚ùå ${data.error}</div>`;
            }
        });
    }
}

function sendToSelected() {
    const templateId = document.getElementById('campaignSelect').value;
    const selectedLeads = Array.from(document.querySelectorAll('.lead-checkbox:checked')).map(cb => cb.value);
    
    if (!templateId) {
        alert('Please select a campaign');
        return;
    }
    
    if (selectedLeads.length === 0) {
        alert('Please select at least one lead');
        return;
    }
    
    const resultsDiv = document.getElementById('sendResults');
    resultsDiv.innerHTML = `<div style="background: #fef3c7; color: #92400e; padding: 1rem; border-radius: 6px;">Sending messages to ${selectedLeads.length} selected leads...</div>`;
    
    fetch('/projects/{{ project.id }}/send-bulk-whatsapp/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            template_id: templateId,
            lead_ids: selectedLeads
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultsDiv.innerHTML = `<div style="background: #ecfdf5; color: #065f46; padding: 1rem; border-radius: 6px;">‚úÖ ${data.message}</div>`;
        } else {
            resultsDiv.innerHTML = `<div style="background: #fef2f2; color: #991b1b; padding: 1rem; border-radius: 6px;">‚ùå ${data.error}</div>`;
        }
    });
}

function toggleMask(element) {
    const isCurrentlyMasked = element.textContent === element.dataset.masked;
    element.textContent = isCurrentlyMasked ? element.dataset.original : element.dataset.masked;
    element.style.color = isCurrentlyMasked ? '#10b981' : '#6b7280';
}

function processPendingMessages() {
    const resultsDiv = document.getElementById('sendResults');
    resultsDiv.innerHTML = '<div style="background: #fef3c7; color: #92400e; padding: 1rem; border-radius: 6px;">Processing pending drip messages...</div>';
    
    fetch('/drip-campaigns/process-pending/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultsDiv.innerHTML = `<div style="background: #ecfdf5; color: #065f46; padding: 1rem; border-radius: 6px;">‚úÖ Processed ${data.processed} messages. Successful: ${data.successful}, Failed: ${data.failed || 0}</div>`;
        } else {
            resultsDiv.innerHTML = `<div style="background: #fef2f2; color: #991b1b; padding: 1rem; border-radius: 6px;">‚ùå ${data.error}</div>`;
        }
    });
}
</script>
{% endblock %}