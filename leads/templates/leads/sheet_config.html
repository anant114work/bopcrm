{% extends 'leads/base_unified.html' %}

{% block title %}Google Sheet Configuration - Meta Leads CRM{% endblock %}

{% block page_title %}üìà Google Sheet Configuration{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin: 0 0 10px 0; color: #1f2937;">Connect Your Google Sheet</h3>
        <p class="small">
            Enter your Google Sheet URL to automatically sync leads with your CRM
        </p>
    </div>

    <form id="sheetConfigForm" style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                Google Sheet URL
            </label>
            <input type="url" id="sheetUrl" name="sheet_url" 
                   placeholder="https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit"
                   value="{{ current_sheet_url }}"
                   class="small"
                   required>
            <div class="small">
                Make sure your Google Sheet is publicly viewable (Anyone with the link can view)
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                Sheet Tab Name (optional)
            </label>
            <input type="text" id="sheetName" name="sheet_name" 
                   placeholder="Sheet1"
                   value="{{ current_sheet_name }}"
                   class="small">
            <div class="small">
                Leave blank to use the first sheet
            </div>
        </div>

        <div class="d-flex">
            <button type="submit" class="btn btn-primary" style="flex: 1;">
                üíæ Save Configuration
            </button>
            <button type="button" onclick="testConnection()" class="btn btn-secondary">
                üîç Test Connection
            </button>
        </div>
    </form>

    <div id="testResult" style="margin-top: 20px; display: none;"></div>

    {% if current_sheet_url %}
    <div style="background: #dcfce7; border: 1px solid #bbf7d0; padding: 16px; border-radius: 8px; margin-top: 20px;">
        <h4 style="margin: 0 0 8px 0; color: #166534;">‚úÖ Sheet Connected</h4>
        <p class="small">
            Your Google Sheet is connected. Use the "Refresh from Google Sheet" button on the Google Leads page to sync data.
        </p>
    </div>
    {% endif %}

    <div style="background: #fef3c7; border: 1px solid #fde68a; padding: 16px; border-radius: 8px; margin-top: 20px;">
        <h4 style="margin: 0 0 8px 0; color: #92400e;">üìã Required Sheet Format</h4>
        <p class="small">
            Your Google Sheet should have these columns:
        </p>
        <div class="small">
            Date & Time | Name | Phone | Email | Unit Size | Project Name
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('sheetConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('sheet_url', document.getElementById('sheetUrl').value);
    formData.append('sheet_name', document.getElementById('sheetName').value);
    
    const btn = document.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Saving...';
    
    fetch('/save-sheet-config/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
            window.location.reload();
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Error: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = originalText;
    });
});

function testConnection() {
    const sheetUrl = document.getElementById('sheetUrl').value;
    if (!sheetUrl) {
        alert('Please enter a Google Sheet URL first');
        return;
    }
    
    const resultDiv = document.getElementById('testResult');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div style="padding: 12px; background: #f3f4f6; border-radius: 6px;">üîÑ Testing connection...</div>';
    
    const formData = new FormData();
    formData.append('sheet_url', sheetUrl);
    formData.append('sheet_name', document.getElementById('sheetName').value);
    
    fetch('/test-sheet-connection/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div style="padding: 12px; background: #dcfce7; border: 1px solid #bbf7d0; border-radius: 6px; color: #166534;">
                    <strong>‚úÖ Connection successful!</strong><br>
                    Found ${data.lead_count} leads in the sheet<br>
                    <small>Sample: ${data.sample_leads.join(', ')}</small>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div style="padding: 12px; background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; color: #dc2626;">
                    <strong>‚ùå Connection failed:</strong><br>
                    ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div style="padding: 12px; background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; color: #dc2626;">
                <strong>‚ùå Error:</strong> ${error}
            </div>
        `;
    });
}


</script>
{% endblock %}