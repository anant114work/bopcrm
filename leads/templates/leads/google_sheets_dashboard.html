{% extends 'leads/base_unified.html' %}

{% block title %}Google Sheets Integration - Meta Leads CRM{% endblock %}
{% block page_title %}Google Sheets Integration{% endblock %}



{% block content %}
<div class="integration-card">
    <h2><i class="fab fa-google"></i> Google Sheets Integration</h2>
    <p>Integrate your Google Sheets forms to automatically sync leads to the CRM.</p>
    
    <!-- Webhook URL -->
    <div style="margin: 20px 0;">
        <h3>Webhook URL</h3>
        <p>Use this URL in your Google Apps Script to send leads to the CRM:</p>
    <div class="webhook-url">
        {{ request.build_absolute_uri }}/google-sheets-webhook/
    </div>
    <button onclick="copyWebhookUrl()" class="btn btn-secondary mt-2">
        <i class="fas fa-copy"></i> Copy URL
    </button>
    <button onclick="testWebhook()" class="btn btn-primary mt-2">
        <i class="fas fa-test-tube"></i> Test Webhook
    </button>
    <button onclick="syncExistingLeads()" class="btn btn-success mt-2">
        <i class="fas fa-sync"></i> Sync Existing Leads
    </button>
    </div>
</div>

<!-- Statistics -->
<div class="integration-card">
    <h3><i class="fas fa-chart-bar"></i> Statistics</h3>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-number">{{ total_google_leads }}</div>
            <div class="stat-label">Total Google Leads</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ sheets.count }}</div>
            <div class="stat-label">Configured Sheets</div>
        </div>
    </div>
</div>

<!-- Add New Sheet -->
<div class="integration-card">
    <h3><i class="fas fa-plus"></i> Add Google Sheet</h3>
    <form method="post" action="/add-google-sheet/">
        {% csrf_token %}
        <div class="gap-2">
            <div>
                <label>Sheet Name:</label>
                <input type="text" name="name" class="form-control" placeholder="AU Aspire Form" required>
            </div>
            <div>
                <label>Sheet Tab Name:</label>
                <input type="text" name="sheet_name" class="form-control" placeholder="Sheet1" value="Sheet1">
            </div>
        </div>
        <div style="margin-bottom: 20px;">
            <label>Google Sheet URL:</label>
            <input type="url" name="sheet_url" class="form-control" placeholder="https://docs.google.com/spreadsheets/d/..." required>
        </div>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-plus"></i> Add Sheet
        </button>
    </form>
</div>

<!-- Configured Sheets -->
<div class="integration-card">
    <h3><i class="fas fa-table"></i> Configured Sheets</h3>
    {% if sheets %}
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Sheet URL</th>
                    <th>Tab Name</th>
                    <th>Status</th>
                    <th>Last Synced</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for sheet in sheets %}
                <tr>
                    <td><strong>{{ sheet.name }}</strong></td>
                    <td>
                        <a href="{{ sheet.sheet_url }}" target="_blank" class="small">
                            {{ sheet.sheet_url|truncatechars:50 }}
                        </a>
                    </td>
                    <td>{{ sheet.sheet_name }}</td>
                    <td>
                        {% if sheet.is_active %}
                        <span class="status-active"><i class="fas fa-check-circle"></i> Active</span>
                        {% else %}
                        <span class="status-inactive"><i class="fas fa-times-circle"></i> Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if sheet.last_synced %}
                        {{ sheet.last_synced|date:"M d, Y H:i" }}
                        {% else %}
                        <span class="text-muted">Never</span>
                        {% endif %}
                    </td>
                    <td>
                        <button onclick="syncIndividualSheet({{ sheet.id }})" class="btn btn-primary" class="small">
                            <i class="fas fa-sync"></i> Sync
                        </button>
                        <button onclick="toggleSheetStatus({{ sheet.id }})" class="btn {% if sheet.is_active %}btn-warning{% else %}btn-success{% endif %}" class="small">
                            <i class="fas fa-{% if sheet.is_active %}pause{% else %}play{% endif %}"></i> {% if sheet.is_active %}Pause{% else %}Activate{% endif %}
                        </button>
                        <button onclick="deleteSheet({{ sheet.id }})" class="btn btn-danger" class="small">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center">
        <i class="fas fa-table" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
        No Google Sheets configured yet
    </div>
    {% endif %}
</div>

<!-- Recent Google Leads -->
<div class="integration-card">
    <h3><i class="fas fa-users"></i> Recent Google Leads</h3>
    {% if google_leads %}
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Contact</th>
                    <th>Form</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for lead in google_leads %}
                <tr>
                    <td><strong>{{ lead.full_name|default:"No Name" }}</strong></td>
                    <td>
                        {% if lead.email %}<div>{{ lead.email }}</div>{% endif %}
                        {% if lead.phone_number %}<div>{{ lead.phone_number }}</div>{% endif %}
                    </td>
                    <td>{{ lead.form_name|truncatechars:30 }}</td>
                    <td>{{ lead.created_time|date:"M d, Y H:i" }}</td>
                    <td>
                        <a href="/leads/{{ lead.id }}/" class="btn btn-primary" class="small">
                            Details
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center">
        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
        No Google leads received yet
    </div>
    {% endif %}
</div>

<!-- Google Apps Script Code -->
<div class="integration-card">
    <h3><i class="fas fa-code"></i> Updated Google Apps Script Code</h3>
    <p>Add this function to your Google Apps Script to send leads to the CRM:</p>
    <pre class="small"><code>// Add this to your existing Google Apps Script
function sendToCRM(data) {
  const CRM_WEBHOOK_URL = '{{ request.build_absolute_uri }}/google-sheets-webhook/';
  
  const payload = {
    name: data.name,
    phone: data.phone,
    email: data.email,
    unit_size: data.unit_size,
    project_name: data.project_name,
    ip: data.ip,
    timestamp: data.timestamp
  };
  
  try {
    const response = UrlFetchApp.fetch(CRM_WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload)
    });
    
    console.log('CRM Response:', response.getContentText());
    return response.getResponseCode() === 200;
  } catch (error) {
    console.error('CRM Error:', error);
    return false;
  }
}

// Update your handleFormSubmission function
function handleFormSubmission(data) {
  const submitted_at = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss");

  data.name = (data.name || '').trim();
  data.phone = (data.phone || '');
  data.email = (data.email || '').trim();
  data.unit_size = (data.unit_size || '').trim();
  data.project_name = (data.project_name || CONFIG.PROJECT_SUBJECT).trim();
  data.timestamp = submitted_at;

  // Update visitor status
  if (data.ip) {
    handleVisitorTracking(data.ip, 'submitted_form');
  }

  // Save to spreadsheet
  storeInSpreadsheet(data);

  // Send email
  sendEmailNotification(data);

  // NEW: Send to CRM
  sendToCRM(data);
}</code></pre>
</div>

<script>
function copyWebhookUrl() {
    const url = '{{ request.build_absolute_uri }}/google-sheets-webhook/';
    navigator.clipboard.writeText(url).then(() => {
        alert('Webhook URL copied to clipboard!');
    });
}

function testWebhook() {
    fetch('/test-google-sheets-webhook/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Webhook test successful! Check recent leads.');
            location.reload();
        } else {
            alert('❌ Webhook test failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('❌ Test error: ' + error.message);
    });
}

function syncExistingLeads() {
    if (!confirm('This will sync sample Google Sheet leads to the CRM. Continue?')) {
        return;
    }
    
    fetch('/sync-existing-google-leads/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ Sync failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('❌ Sync error: ' + error.message);
    });
}

function syncIndividualSheet(sheetId) {
    if (!confirm('Sync this Google Sheet individually?')) {
        return;
    }
    
    fetch(`/sync-individual-sheet/${sheetId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ Sync failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('❌ Sync error: ' + error.message);
    });
}

function toggleSheetStatus(sheetId) {
    fetch(`/toggle-sheet-status/${sheetId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ Toggle failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('❌ Toggle error: ' + error.message);
    });
}

function deleteSheet(sheetId) {
    if (!confirm('Are you sure you want to delete this Google Sheet configuration? This cannot be undone.')) {
        return;
    }
    
    fetch(`/delete-google-sheet/${sheetId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ Delete failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('❌ Delete error: ' + error.message);
    });
}
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}