{% extends 'leads/base_unified.html' %}

{% block title %}AI Agent Management{% endblock %}
{% block page_title %}AI Agent Management{% endblock %}

{% block content %}
<div class="integration-card">
    <h2><i class="fas fa-robot"></i> CallKaro AI Agents</h2>
    
    <!-- Add New Agent -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3><i class="fas fa-plus"></i> Add New Agent</h3>
        <form method="post" action="{% url 'add_agent' %}">
            {% csrf_token %}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label><strong>Agent Name:</strong></label>
                    <input type="text" name="name" class="form-control" placeholder="AU Aspire Agent" required>
                </div>
                <div>
                    <label><strong>Agent ID:</strong></label>
                    <input type="text" name="agent_id" class="form-control" placeholder="agent_12345abc" required>
                </div>
                <div>
                    <label><strong>Agent Type:</strong></label>
                    <select name="agent_type" class="form-control">
                        <option value="general">General Purpose</option>
                        <option value="lead_qualification">Lead Qualification</option>
                        <option value="project_specific">Project Specific</option>
                        <option value="follow_up">Follow Up</option>
                    </select>
                </div>
                <div>
                    <label><strong>Project Name (Optional):</strong></label>
                    <input type="text" name="project_name" class="form-control" placeholder="AU Aspire">
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label><strong>Description (Optional):</strong></label>
                <textarea name="description" class="form-control" rows="2" placeholder="Agent description..."></textarea>
            </div>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-plus"></i> Add Agent
            </button>
        </form>
    </div>

    <!-- Existing Agents -->
    <h3><i class="fas fa-list"></i> Existing Agents ({{ agents.count }})</h3>
    {% if agents %}
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Agent ID</th>
                    <th>Type</th>
                    <th>Project</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for agent in agents %}
                <tr>
                    <td><strong>{{ agent.name }}</strong></td>
                    <td><code>{{ agent.agent_id }}</code></td>
                    <td>
                        <span class="badge badge-info">{{ agent.get_agent_type_display }}</span>
                    </td>
                    <td>{{ agent.project_name|default:"-" }}</td>
                    <td>
                        {% if agent.is_active %}
                        <span class="status-active"><i class="fas fa-check-circle"></i> Active</span>
                        {% else %}
                        <span class="status-inactive"><i class="fas fa-times-circle"></i> Inactive</span>
                        {% endif %}
                    </td>
                    <td>{{ agent.created_at|date:"M d, Y" }}</td>
                    <td>
                        <button onclick="toggleAgent({{ agent.id }})" class="btn btn-sm {% if agent.is_active %}btn-warning{% else %}btn-success{% endif %}">
                            <i class="fas fa-{% if agent.is_active %}pause{% else %}play{% endif %}"></i>
                        </button>
                        <button onclick="deleteAgent({{ agent.id }})" class="btn btn-sm btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center" style="padding: 40px;">
        <i class="fas fa-robot" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
        <p>No agents configured yet. Add your first agent above!</p>
    </div>
    {% endif %}
</div>

<script>
function toggleAgent(agentId) {
    fetch(`/toggle-agent/${agentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function deleteAgent(agentId) {
    if (!confirm('Are you sure you want to delete this agent?')) return;
    
    fetch(`/delete-agent/${agentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
