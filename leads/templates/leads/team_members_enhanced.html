{% extends 'leads/base_unified.html' %}

{% block title %}Team Members - CRM{% endblock %}
{% block page_title %}Team Members{% endblock %}



{% block content %}
<div class="team-container">
    <!-- Header -->
    <div class="team-header">
        <div class="header-top">
            <div class="header-title">
                <div class="title-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <h1>Team Members</h1>
                    <p class="text-muted">Manage your team members and their assignments</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="/team/hierarchy/" class="btn btn-secondary">
                    <i class="fas fa-sitemap"></i> Hierarchy View
                </a>
                <a href="/team/create/" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Member
                </a>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="stat-number">{{ total_members }}</div>
                <div class="stat-label">Total Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
                <div class="stat-number">{{ active_members }}</div>
                <div class="stat-label">Active Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                </div>
                <div class="stat-number">{{ total_leads }}</div>
                <div class="stat-label">Total Assigned Leads</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <form method="get" id="filterForm">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Search Members</label>
                    <input type="text" name="search" class="filter-input" placeholder="Search by name, email, or phone..." value="{{ search }}">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Role</label>
                    <select name="role" class="filter-input">
                        <option value="">All Roles</option>
                        {% for role in all_roles %}
                        <option value="{{ role }}" {% if role == role_filter %}selected{% endif %}>{{ role }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select name="status" class="filter-input">
                        <option value="">All Status</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Filter
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Team Members -->
    <div class="team-section">
        <div class="section-header">
            <h3>
                <i class="fas fa-users"></i> 
                Team Members 
                {% if members.paginator.count %}
                ({{ members.start_index }}-{{ members.end_index }} of {{ members.paginator.count }})
                {% endif %}
            </h3>
            <div class="text-muted">
                Page {{ members.number }} of {{ members.paginator.num_pages }}
            </div>
        </div>

        {% if members %}
        <div class="members-grid">
            {% for member in members %}
            <div class="member-card">
                <div class="member-header">
                    <div class="member-info">
                        <h3>{{ member.name }}</h3>
                        <div class="member-role">{{ member.role }}</div>
                    </div>
                    <div>
                        {% if member.is_active %}
                        <span class="status-badge status-active">Active</span>
                        {% else %}
                        <span class="status-badge status-inactive">Inactive</span>
                        {% endif %}
                    </div>
                </div>

                <div class="member-details">
                    <div class="detail-row">
                        <i class="fas fa-envelope detail-icon"></i>
                        <span>{{ member.email|default:"No email" }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-phone detail-icon"></i>
                        <span>{{ member.phone|default:"No phone" }}</span>
                    </div>
                    {% if member.parent_user %}
                    <div class="detail-row">
                        <i class="fas fa-user-tie detail-icon"></i>
                        <span>Reports to: {{ member.parent_user.name }}</span>
                    </div>
                    {% else %}
                    <div class="detail-row">
                        <i class="fas fa-crown detail-icon"></i>
                        <span>Team Lead</span>
                    </div>
                    {% endif %}
                </div>

                <div class="member-stats">
                    <span class="text-muted">Assigned Leads:</span>
                    <span class="leads-count">{{ member.assigned_leads.count|default:0 }}</span>
                </div>

                <div class="member-actions" style="margin-top: 1rem;">
                    <button class="btn btn-secondary btn-sm" onclick="editMember({{ member.id }}, '{{ member.name }}', '{{ member.role }}', '{{ member.email }}', '{{ member.phone }}', {{ member.is_active|yesno:'true,false' }})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="viewMemberLeads({{ member.id }}, '{{ member.name }}')">
                        <i class="fas fa-clipboard-list"></i> Leads
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-users empty-icon"></i>
            <div class="empty-title">No Team Members Found</div>
            <div class="empty-description">
                {% if search or role_filter or status_filter %}
                Try adjusting your filters or search terms.
                {% else %}
                Add team members to get started with your CRM.
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if members.paginator.num_pages > 1 %}
    <div class="pagination-container">
        <div class="page-info">
            Showing {{ members.start_index }}-{{ members.end_index }} of {{ members.paginator.count }} members
        </div>
        <div class="pagination">
            {% if members.has_previous %}
            <a href="?page=1{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-link">
                <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="?page={{ members.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-link">
                <i class="fas fa-angle-left"></i>
            </a>
            {% endif %}

            {% for num in members.paginator.page_range %}
            {% if num == members.number %}
            <span class="page-link active">{{ num }}</span>
            {% elif num > members.number|add:'-3' and num < members.number|add:'3' %}
            <a href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-link">{{ num }}</a>
            {% endif %}
            {% endfor %}

            {% if members.has_next %}
            <a href="?page={{ members.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-link">
                <i class="fas fa-angle-right"></i>
            </a>
            <a href="?page={{ members.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}" class="page-link">
                <i class="fas fa-angle-double-right"></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Edit Member Modal -->
<div id="editModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; backdrop-filter: blur(4px);">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <div class="d-flex">
            <div class="d-flex">
                <i class="fas fa-user-edit"></i>
            </div>
            <div>
                <h3>Edit Team Member</h3>
                <p class="text-muted">Update member information</p>
            </div>
        </div>
        
        <div class="gap-2">
            <div style="margin-bottom: 1.5rem;">
                <label class="mb-0">Name *</label>
                <input type="text" id="editName" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;" required>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label class="mb-0">Role *</label>
                <input type="text" id="editRole" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;" required>
            </div>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <label class="mb-0">Email *</label>
            <input type="email" id="editEmail" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;" required>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <label class="mb-0">Phone</label>
            <input type="text" id="editPhone" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem;">
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <div class="d-flex">
                <input type="checkbox" id="editActive">
                <label for="editActive">Active Member</label>
            </div>
        </div>
        
        <div class="d-flex">
            <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateMember()">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>
</div>

<script>
let editMemberId = null;

// Show success/error messages
function showMessage(message, type = 'success') {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
    
    const alertDiv = document.createElement('div');
    alertDiv.innerHTML = `
        <div class="d-flex">
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 4000);
}

// Edit Modal Functions
function editMember(memberId, name, role, email, phone, isActive) {
    editMemberId = memberId;
    document.getElementById('editName').value = name;
    document.getElementById('editRole').value = role;
    document.getElementById('editEmail').value = email;
    document.getElementById('editPhone').value = phone || '';
    document.getElementById('editActive').checked = isActive;
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    editMemberId = null;
}

function updateMember() {
    const name = document.getElementById('editName').value.trim();
    const role = document.getElementById('editRole').value.trim();
    const email = document.getElementById('editEmail').value.trim();
    const phone = document.getElementById('editPhone').value.trim();
    const isActive = document.getElementById('editActive').checked;
    
    if (!name || !role || !email) {
        showMessage('Please fill in all required fields', 'error');
        return;
    }
    
    const button = event.target;
    button.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></span> Saving...';
    button.disabled = true;
    
    fetch('/team/edit/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
            member_id: editMemberId,
            name: name,
            role: role,
            email: email,
            phone: phone,
            is_active: isActive
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showMessage('Team member updated successfully!');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.error || 'Update failed', 'error');
        }
    })
    .catch(error => {
        showMessage('Error: Unable to update member', 'error');
        console.error('Error:', error);
    })
    .finally(() => {
        button.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        button.disabled = false;
    });
}

function viewMemberLeads(memberId, memberName) {
    // Redirect to member's leads page
    window.location.href = `/leads/?assigned_to=${memberId}`;
}

// Close modal when clicking outside
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) closeEditModal();
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
    }
});

// Auto-submit form on filter change
document.querySelectorAll('select[name="role"], select[name="status"]').forEach(select => {
    select.addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
});
</script>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}