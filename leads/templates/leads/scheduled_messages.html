{% extends 'leads/base_unified.html' %}

{% block title %}Scheduled Messages - Meta Leads CRM{% endblock %}

{% block page_title %}‚è∞ Scheduled WhatsApp Messages{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 30px;">
    <h2 style="margin-bottom: 20px; color: #1e293b;">Message Scheduler Control</h2>
    
    <div class="gap-2">
        <button class="btn btn-primary" onclick="processScheduled()">
            Process Due Messages Now
        </button>
        <button class="btn btn-secondary" onclick="checkStatus()">
            Check Status
        </button>
        <button class="btn" style="background: #10b981; color: white;" onclick="autoRefresh()">
            Auto Refresh (30s)
        </button>
    </div>
    
    <div id="statusDisplay" class="small">
        Click "Check Status" to see scheduled messages...
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom: 16px;">Server Setup Instructions</h3>
    <div style="background: #fef3c7; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
        <h4 style="color: #92400e; margin-bottom: 8px;">Automatic Processing Options:</h4>
        
        <p style="margin-bottom: 8px;"><strong>1. Background Task (Recommended):</strong></p>
        <p class="small">The system automatically processes messages every minute when Django is running.</p>
        
        <p style="margin-bottom: 8px;"><strong>2. Server Cron Job:</strong> Add to your server's crontab:</p>
        <code style="background: #374151; color: #f3f4f6; padding: 8px; border-radius: 4px; display: block; margin: 8px 0;">
            */5 * * * * curl -s http://yourdomain.com/auto-process/
        </code>
        
        <p style="margin-bottom: 8px;"><strong>3. Manual Processing:</strong> Use the "Process Due Messages Now" button above</p>
        
        <p style="margin-bottom: 8px;"><strong>4. Django Management Command:</strong></p>
        <code style="background: #374151; color: #f3f4f6; padding: 8px; border-radius: 4px; display: block; margin: 8px 0;">
            python manage.py process_scheduled_messages
        </code>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let autoRefreshInterval;
    
    function processScheduled() {
        updateStatus('Processing scheduled messages...');
        
        fetch('/process-scheduled/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `‚úÖ Processing Complete\n\n`;
                message += `üìä Summary:\n`;
                message += `   ‚Ä¢ Sent: ${data.sent}\n`;
                message += `   ‚Ä¢ Failed: ${data.failed}\n`;
                message += `   ‚Ä¢ Total Processed: ${data.total_processed}\n\n`;
                
                if (data.results && data.results.length > 0) {
                    message += `üìã Details:\n`;
                    data.results.forEach(result => {
                        message += `   ${result}\n`;
                    });
                }
                
                updateStatus(message);
            } else {
                updateStatus('‚ùå Error processing scheduled messages: ' + data.error);
            }
        })
        .catch(error => {
            updateStatus('‚ùå Network Error: ' + error);
        });
    }
    
    function checkStatus() {
        updateStatus('Checking scheduled messages status...');
        
        fetch('/check-scheduled/')
        .then(response => response.json())
        .then(data => {
            let message = `üìä Scheduled Messages Status\n`;
            message += `üïí Current Time: ${data.current_time}\n\n`;
            message += `üìà Statistics:\n`;
            message += `   ‚Ä¢ Total Scheduled: ${data.total_scheduled}\n`;
            message += `   ‚Ä¢ Due Now: ${data.due_messages}\n\n`;
            
            if (data.messages && data.messages.length > 0) {
                message += `üìã Recent Messages:\n`;
                data.messages.forEach(msg => {
                    const status = msg.is_sent ? '‚úÖ Sent' : (msg.error_message ? '‚ùå Failed' : '‚è≥ Pending');
                    message += `   ${status} - ${msg.lead_name}\n`;
                    message += `      üì± ${msg.lead_phone}\n`;
                    message += `      üìù Template: ${msg.template}\n`;
                    message += `      ‚è∞ Scheduled: ${msg.scheduled_time}\n`;
                    if (msg.sent_at) {
                        message += `      ‚úÖ Sent: ${msg.sent_at}\n`;
                    }
                    if (msg.error_message) {
                        message += `      ‚ùå Error: ${msg.error_message}\n`;
                    }
                    message += `\n`;
                });
            } else {
                message += `üì≠ No scheduled messages found\n`;
            }
            
            updateStatus(message);
        })
        .catch(error => {
            updateStatus('‚ùå Network Error: ' + error);
        });
    }
    
    function autoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            document.querySelector('button[onclick="autoRefresh()"]').textContent = 'Auto Refresh (30s)';
            updateStatus('Auto refresh stopped.');
        } else {
            autoRefreshInterval = setInterval(checkStatus, 30000);
            document.querySelector('button[onclick="autoRefresh()"]').textContent = 'Stop Auto Refresh';
            updateStatus('Auto refresh started (every 30 seconds)...');
            checkStatus();
        }
    }
    
    function updateStatus(message) {
        document.getElementById('statusDisplay').textContent = message;
    }
    
    // Initial status check
    document.addEventListener('DOMContentLoaded', function() {
        checkStatus();
    });
</script>
{% endblock %}