{% extends 'leads/base_unified.html' %}

{% block title %}Form Source Mappings - Meta Leads CRM{% endblock %}
{% block page_title %}Form Source Mappings{% endblock %}



{% block content %}
<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-diagram-project"></i> Form Source Mappings</h2>
    </div>
    <div class="card-content">
        <div class="d-flex">
            <p>Map lead forms to projects for better organization and auto-calling.</p>
            <div class="d-flex">
                <button onclick="showBulkModal()" class="btn btn-success">
                    <i class="fas fa-plus"></i> Bulk Assign Forms
                </button>
                <button onclick="showAddModal()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Single Mapping
                </button>
            </div>
        </div>

        <!-- Mappings Table -->
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Form Name</th>
                        <th>Project</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mapping in mappings %}
                    <tr id="mapping-{{ mapping.id }}">
                        <td>
                            <strong>{{ mapping.form_name }}</strong>
                            {% if 'Google Sheets' in mapping.form_name %}
                                <span class="google-sheets-badge"><i class="fab fa-google"></i> Google</span>
                            {% endif %}
                        </td>
                        <td>
                            <span style="color: var(--primary-dark); font-weight: 600;">{{ mapping.project.name }}</span>
                        </td>
                        <td>
                            {% if mapping.is_active %}
                                <span class="small">
                                    <i class="fas fa-check-circle"></i> Active
                                </span>
                            {% else %}
                                <span class="small">
                                    <i class="fas fa-times-circle"></i> Inactive
                                </span>
                            {% endif %}
                        </td>
                        <td>{{ mapping.created_at|date:"M d, Y" }}</td>
                        <td>
                            <button onclick="toggleMapping({{ mapping.id }})" class="btn btn-sm btn-secondary" style="margin-right: 5px;">
                                {% if mapping.is_active %}Deactivate{% else %}Activate{% endif %}
                            </button>
                            <button onclick="deleteMapping({{ mapping.id }})" class="btn btn-sm btn-danger">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">
                            <i class="fas fa-diagram-project" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                            No form mappings yet. Click "Add Mapping" to create one.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Bulk Assign Modal -->
<div id="bulkModal" class="modal">
    <div class="modal-content">
        <div class="d-flex">
            <h3 style="margin: 0; color: var(--primary-dark);"><i class="fas fa-layer-group"></i> Bulk Assign Forms to Project</h3>
            <button onclick="hideBulkModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
            
        <div class="form-group">
            <label>Select Project <span style="color: #ef4444;">*</span></label>
            <select id="bulkProjectSelect" class="form-control">
                <option value="">Select Project</option>
                {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }} - {{ project.location }}</option>
                {% endfor %}
            </select>
        </div>
            
        <div class="form-group">
            <label>Select Forms <span style="color: #ef4444;">*</span></label>
            <div class="form-checkbox-list">
                <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb;">
                    <label class="d-flex">
                        <input type="checkbox" id="selectAllForms" onchange="toggleAllForms()" style="margin-right: 8px;">
                        <i class="fas fa-check-double"></i> Select All Unmapped Forms ({{ unmapped_forms|length }})
                    </label>
                </div>
                {% if unmapped_forms %}
                    {% for form in unmapped_forms %}
                    <div style="margin-bottom: 5px;">
                        <label class="d-flex" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox" name="bulk_forms" value="{{ form }}" style="margin-right: 8px;">
                            <span class="small">
                                {% if 'Google Sheets' in form %}
                                    <i class="fab fa-google" style="color: #4285f4; margin-right: 5px;"></i>
                                {% else %}
                                    <i class="fab fa-meta" style="color: #1877f2; margin-right: 5px;"></i>
                                {% endif %}
                                {{ form }}
                            </span>
                        </label>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">All forms are already mapped. You can still select from all forms below.</p>
                {% endif %}
                    
                {% if unique_forms %}
                <div style="margin: 15px 0; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <div style="margin-bottom: 10px;">
                        <span class="text-muted"><i class="fas fa-list"></i> All Forms (including mapped)</span>
                    </div>
                    {% for form in unique_forms %}
                        {% if form not in unmapped_forms %}
                        <div style="margin-bottom: 5px;">
                            <label class="d-flex" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" name="bulk_forms" value="{{ form }}" style="margin-right: 8px;">
                                <span class="text-muted">
                                    {% if 'Google Sheets' in form %}
                                        <i class="fab fa-google" style="color: #4285f4; margin-right: 5px;"></i>
                                    {% else %}
                                        <i class="fab fa-meta" style="color: #1877f2; margin-right: 5px;"></i>
                                    {% endif %}
                                    {{ form }} <span class="small">(already mapped)</span>
                                </span>
                            </label>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <small class="text-muted">Select multiple forms to assign to the project</small>
        </div>
        
        <div class="d-flex">
            <button onclick="hideBulkModal()" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button onclick="saveBulkMapping()" class="btn btn-success">
                <i class="fas fa-check"></i> Assign Forms
            </button>
        </div>
    </div>
</div>

<!-- Add Mapping Modal -->
<div id="addModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="d-flex">
            <h3 style="margin: 0; color: var(--primary-dark);"><i class="fas fa-plus"></i> Add Single Form Mapping</h3>
            <button onclick="hideAddModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        
        <div class="form-group">
            <label>Form Name</label>
            <input type="text" id="formNameInput" list="formNames" class="form-control" placeholder="Select or type form name">
            <datalist id="formNames">
                {% for form in unique_forms %}
                <option value="{{ form }}">
                {% endfor %}
            </datalist>
        </div>
        
        <div class="form-group">
            <label>Project</label>
            <select id="projectSelect" class="form-control">
                <option value="">Select Project</option>
                {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="d-flex">
            <button onclick="hideAddModal()" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button onclick="saveMapping()" class="btn btn-primary">
                <i class="fas fa-save"></i> Save
            </button>
        </div>
    </div>
</div>

<script>
function showBulkModal() {
    document.getElementById('bulkModal').style.display = 'block';
}

function hideBulkModal() {
    document.getElementById('bulkModal').style.display = 'none';
    document.getElementById('bulkProjectSelect').value = '';
    document.querySelectorAll('input[name="bulk_forms"]').forEach(cb => cb.checked = false);
    document.getElementById('selectAllForms').checked = false;
}

function toggleAllForms() {
    const selectAll = document.getElementById('selectAllForms');
    const unmappedCheckboxes = document.querySelectorAll('input[name="bulk_forms"]');
    unmappedCheckboxes.forEach(cb => {
        // Only toggle unmapped forms (those without "already mapped" text)
        if (!cb.parentElement.textContent.includes('already mapped')) {
            cb.checked = selectAll.checked;
        }
    });
}

async function saveBulkMapping() {
    const projectId = document.getElementById('bulkProjectSelect').value;
    const selectedForms = Array.from(document.querySelectorAll('input[name="bulk_forms"]:checked'))
        .map(cb => cb.value);
    
    if (!projectId) {
        alert('Please select a project');
        return;
    }
    
    if (selectedForms.length === 0) {
        alert('Please select at least one form');
        return;
    }
    
    try {
        const response = await fetch('/form-mappings/bulk-create/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({form_names: selectedForms, project_id: projectId})
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error);
    }
}

function showAddModal() {
    document.getElementById('addModal').style.display = 'block';
}

function hideAddModal() {
    document.getElementById('addModal').style.display = 'none';
    document.getElementById('formNameInput').value = '';
    document.getElementById('projectSelect').value = '';
}

async function saveMapping() {
    const formName = document.getElementById('formNameInput').value;
    const projectId = document.getElementById('projectSelect').value;
    
    if (!formName || !projectId) {
        alert('Please fill all fields');
        return;
    }
    
    try {
        const response = await fetch('/form-mappings/create/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({form_name: formName, project_id: projectId})
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error);
    }
}

async function toggleMapping(id) {
    try {
        const response = await fetch(`/form-mappings/${id}/toggle/`, {method: 'POST'});
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error);
    }
}

async function deleteMapping(id) {
    if (!confirm('Are you sure you want to delete this mapping?')) return;
    
    try {
        const response = await fetch(`/form-mappings/${id}/delete/`, {method: 'POST'});
        const data = await response.json();
        
        if (data.success) {
            document.getElementById(`mapping-${id}`).remove();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error);
    }
}
</script>
{% endblock %}
