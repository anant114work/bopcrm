{% extends 'leads/base_sidebar.html' %}
{% load lead_filters %}

{% block title %}Tata Data Dashboard{% endblock %}
{% block page_title %}ğŸ¢ Tata Data Dashboard{% endblock %}

{% block extra_css %}
<style>
    .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .data-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .data-card h3 {
        margin-bottom: 1rem;
        color: #1e293b;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.5rem;
    }
    .dept-item {
        padding: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        margin-bottom: 1rem;
    }
    .dept-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .dept-name {
        font-weight: 600;
        color: #1e293b;
    }
    .dept-stats {
        font-size: 0.75rem;
        color: #64748b;
    }
    .agents-list {
        margin-top: 0.5rem;
        padding-left: 1rem;
    }
    .agent-item {
        padding: 0.25rem 0;
        font-size: 0.875rem;
        color: #374151;
    }
    .recording-item {
        padding: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .recording-name {
        font-weight: 500;
    }
    .recording-url {
        font-size: 0.75rem;
        color: #3b82f6;
    }
    .sync-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}


<div class="sync-controls">
    <button class="btn btn-primary" onclick="syncAllData()">ğŸ”„ Sync All Tata Data</button>
    <button class="btn btn-secondary" onclick="debugAPI()">ğŸ”§ Debug API</button>
</div>

<div class="data-grid">
    <div class="data-card">
        <h3>ğŸ“ Departments ({{ departments|length }})</h3>
        {% for dept in departments %}
        <div class="dept-item">
            <div class="dept-header">
                <div class="dept-name">{{ dept.name }}</div>
                <div class="dept-stats">
                    {{ dept.calls_answered }} answered / {{ dept.calls_missed }} missed
                </div>
            </div>
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">
                {{ dept.description|truncatechars:50 }}
            </div>
            <div style="font-size: 0.75rem; color: #64748b;">
                Strategy: {{ dept.ring_strategy }} | Queue: {{ dept.use_as_queue|yesno:"Yes,No" }}
            </div>
            {% if dept.tataagent_set.all %}
            <div class="agents-list">
                <strong style="font-size: 0.75rem;">Agents:</strong>
                {% for agent in dept.tataagent_set.all %}
                <div class="agent-item">
                    â€¢ {{ agent.name }} ({{ agent.extension_id }})
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% empty %}
        <p style="color: #64748b; text-align: center; padding: 2rem;">
            No departments found. Click "Sync All Tata Data" to fetch data.
        </p>
        {% endfor %}
    </div>

    <div class="data-card">
        <h3>ğŸ‘¥ Agents ({{ agents|length }})</h3>
        {% for agent in agents %}
        <div class="agent-item" style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
            <div style="font-weight: 500;">{{ agent.name }}</div>
            <div style="font-size: 0.75rem; color: #64748b;">
                Extension: {{ agent.extension_id }} | 
                Department: {{ agent.department.name|default:"Unassigned" }}
            </div>
        </div>
        {% empty %}
        <p style="color: #64748b; text-align: center; padding: 2rem;">
            No agents found. Sync data to see agents.
        </p>
        {% endfor %}
    </div>

    <div class="data-card">
        <h3>ğŸµ Recordings ({{ recordings|length }})</h3>
        {% for recording in recordings %}
        <div class="recording-item">
            <div>
                <div class="recording-name">{{ recording.name }}</div>
                <div style="font-size: 0.75rem; color: #64748b;">
                    {% if recording.music_on_hold %}Music on Hold{% endif %}
                    {% if recording.is_default %}| Default{% endif %}
                </div>
            </div>
            <a href="{{ recording.url }}" target="_blank" class="recording-url">
                ğŸ§ Play
            </a>
        </div>
        {% empty %}
        <p style="color: #64748b; text-align: center; padding: 2rem;">
            No recordings found. Sync data to see recordings.
        </p>
        {% endfor %}
    </div>

    <div class="data-card">
        <h3>ğŸ“ Recent Calls ({{ recent_calls|length }})</h3>
        {% for call in recent_calls %}
        <div style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
                <div style="font-weight: 500;">{% maskable_number call.customer_number "phone" %}</div>
                <div style="font-size: 0.75rem; color: #64748b;">
                    Agent: {{ call.agent_name|default:"Unknown" }} | Duration: {{ call.duration }}s
                    {% if call.recording_url %}
                    | <a href="{{ call.recording_url }}" target="_blank" style="color: #3b82f6; text-decoration: none;">ğŸ§ Recording</a>
                    {% endif %}
                </div>
            </div>
            <span style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; {% if call.status == 'answered' %}background: #dcfce7; color: #166534;{% else %}background: #fef2f2; color: #dc2626;{% endif %}">
                {{ call.status }}
            </span>
        </div>
        {% empty %}
        <p style="color: #64748b; text-align: center; padding: 2rem;">
            No calls found. Check the ğŸ“ Calls section for call data.
        </p>
        {% endfor %}
    </div>

    <div class="data-card">
        <h3>ğŸ“Š Summary</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 6px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">{{ departments|length }}</div>
                <div style="font-size: 0.75rem; color: #64748b;">Departments</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 6px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">{{ agents|length }}</div>
                <div style="font-size: 0.75rem; color: #64748b;">Agents</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 6px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">{{ recordings|length }}</div>
                <div style="font-size: 0.75rem; color: #64748b;">Recordings</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 6px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">{{ total_calls }}</div>
                <div style="font-size: 0.75rem; color: #64748b;">Total Calls</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function syncAllData() {
    if (confirm('This will sync all departments, agents, and recordings from Tata. Continue?')) {
        fetch('/ivr-webhooks/sync-all-data/', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            console.log('Sync Response:', data);
            let message = data.message || 'Sync completed';
            if (data.debug && data.debug.errors.length > 0) {
                message += '\n\nErrors: ' + data.debug.errors.join(', ');
            }
            alert(message);
            location.reload();
        })
        .catch(error => {
            console.error('Sync Error:', error);
            alert('Sync failed: ' + error);
        });
    }
}

function debugAPI() {
    fetch('/ivr-webhooks/debug-api/')
    .then(response => response.json())
    .then(data => {
        console.log('Tata API Debug:', data);
        alert('API Debug completed - check console for details');
    })
    .catch(error => {
        alert('Debug failed: ' + error);
    });
}

function toggleMask(element) {
    const isCurrentlyMasked = element.textContent === element.dataset.masked;
    element.textContent = isCurrentlyMasked ? element.dataset.original : element.dataset.masked;
    element.style.color = isCurrentlyMasked ? '#10b981' : '#6b7280';
}
</script>
{% endblock %}