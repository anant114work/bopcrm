<!DOCTYPE html>
<html>
<head>
    <title>Calls Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f8fafc; }
        .header { background: white; padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .container { padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #1e293b; }
        .stat-label { color: #64748b; font-size: 0.875rem; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .calls-table { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        .table-header { background: #f8fafc; padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .btn { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #2563eb; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        th { background: #f8fafc; font-weight: 600; color: #475569; }
        .status-answered { color: #10b981; font-weight: 600; }
        .status-missed { color: #ef4444; font-weight: 600; }
        .agent-name { font-weight: 500; color: #1e293b; }
        .phone-number { font-family: monospace; color: #3b82f6; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“ž Calls Dashboard</h1>
        <button class="btn" onclick="syncAllCalls()">ðŸ”„ Sync All Calls</button>
    </div>
    
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCalls">0</div>
                <div class="stat-label">Total Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="answeredCalls">0</div>
                <div class="stat-label">Answered</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="missedCalls">0</div>
                <div class="stat-label">Missed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgDuration">0s</div>
                <div class="stat-label">Avg Duration</div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3>Call Status Distribution</h3>
                <canvas id="statusChart" width="400" height="200"></canvas>
            </div>
            <div class="chart-card">
                <h3>Calls by Agent</h3>
                <canvas id="agentChart" width="400" height="200"></canvas>
            </div>
        </div>
        
        <div class="calls-table">
            <div class="table-header">
                <h3>Recent Calls</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Phone Number</th>
                        <th>Agent</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="callsTableBody">
                    <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let statusChart, agentChart;
        
        function loadCallsData() {
            fetch('/ivr-webhooks/api/calls-analytics/')
            .then(response => response.json())
            .then(data => {
                // Update stats
                document.getElementById('totalCalls').textContent = data.total || 0;
                document.getElementById('answeredCalls').textContent = data.answered || 0;
                document.getElementById('missedCalls').textContent = data.missed || 0;
                document.getElementById('avgDuration').textContent = (data.avgDuration || 0) + 's';
                
                // Update charts
                updateStatusChart(data.statusData || {answered: 0, missed: 0});
                updateAgentChart(data.agentData || {});
                
                // Update table
                updateCallsTable(data.calls || []);
            });
        }
        
        function updateStatusChart(data) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            if (statusChart) statusChart.destroy();
            
            statusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Answered', 'Missed'],
                    datasets: [{
                        data: [data.answered, data.missed],
                        backgroundColor: ['#10b981', '#ef4444']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        function updateAgentChart(data) {
            const ctx = document.getElementById('agentChart').getContext('2d');
            if (agentChart) agentChart.destroy();
            
            agentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Calls',
                        data: Object.values(data),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        function updateCallsTable(calls) {
            const tbody = document.getElementById('callsTableBody');
            tbody.innerHTML = calls.map(call => `
                <tr>
                    <td class="phone-number ${isAdmin ? 'maskable-number' : ''}" ${isAdmin ? `data-masked="${maskNumber(call.customer_number)}" data-original="${call.customer_number}" onclick="toggleMask(this)" style="cursor: pointer;"` : ''}>${maskNumber(call.customer_number)}</td>
                    <td class="agent-name">${call.agent_name || 'Unknown'}</td>
                    <td class="status-${call.status}">${call.status}</td>
                    <td>${call.duration}s</td>
                    <td>${call.start_time}</td>
                </tr>
            `).join('') || '<tr><td colspan="5">No calls found</td></tr>';
        }
        
        function syncAllCalls() {
            fetch('/ivr-webhooks/sync-all-calls/', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                alert(data.message || 'Sync completed');
                loadCallsData();
            });
        }
        
        // Check if user is admin
        const isAdmin = {{ request.user.is_superuser|yesno:"true,false" }} || {{ request.session.is_admin|yesno:"true,false" }};
        
        // Mask number function - always mask for display, admin can click to unmask
        function maskNumber(value) {
            if (!value) return value;
            const clean = value.toString().replace(/\D/g, '');
            if (clean.length >= 10) {
                return clean.substring(0, 2) + 'xxxx' + clean.substring(clean.length - 2);
            } else if (clean.length >= 6) {
                return clean.substring(0, 2) + 'xxxx' + clean.substring(clean.length - 2);
            } else if (clean.length >= 4) {
                return clean.substring(0, 1) + 'xxxx' + clean.substring(clean.length - 1);
            }
            return 'xxxx';
        }
        
        // Toggle mask function
        function toggleMask(element) {
            const isCurrentlyMasked = element.textContent === element.dataset.masked;
            element.textContent = isCurrentlyMasked ? element.dataset.original : element.dataset.masked;
            element.style.color = isCurrentlyMasked ? '#3b82f6' : '#6b7280';
        }
        
        loadCallsData();
        setInterval(loadCallsData, 30000);
    </script>
</body>
</html>